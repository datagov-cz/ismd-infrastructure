name: 'Terraform Deployment'

on:
  # Manual trigger for infrastructure updates
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
        default: dev

jobs:
  shared_global_pre:
    name: 'Shared-Global Pre'
    uses: datagov-cz/ismd-infrastructure/.github/workflows/terraform-shared-global.yml@dev
    secrets: inherit
    with:
      environment: ${{ github.event.inputs.environment }}
      dev_hostname: ${{ vars.DEV_HOSTNAME }}
      test_hostname: ${{ vars.TEST_HOSTNAME }}
      prod_hostname: ${{ vars.PROD_HOSTNAME }}
      # Pass 1: omit domain so pools can be empty if env not created yet
      apply: true

  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    needs: [shared_global_pre]
    environment: ${{ github.event.inputs.environment == 'prod' && 'PROD' || github.event.inputs.environment == 'test' && 'TEST' || 'DEV' }}
    outputs:
      job_status: ${{ job.status }}
    
    defaults:
      run:
        working-directory: .
    
    steps:
    - name: Checkout
      uses: actions/checkout@v5
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.11.3'
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Export ARM credentials for Terraform
      env:
        ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      run: |
        echo "ARM_CLIENT_ID=$ARM_CLIENT_ID" >> $GITHUB_ENV
        echo "ARM_CLIENT_SECRET=$ARM_CLIENT_SECRET" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=$ARM_TENANT_ID" >> $GITHUB_ENV
    
    - name: Select Environment
      id: select-env
      run: |
        ENV="${{ github.event.inputs.environment }}"
        echo "ENVIRONMENT=$ENV" >> $GITHUB_ENV
        echo "STATE_KEY=$ENV/terraform.tfstate" >> $GITHUB_ENV
    
    - name: Check shared-global state exists
      run: |
        # Verify the shared-global remote state blob exists; if not, fail early with guidance
        RG="ismd-shared-tfstate"
        SA="ismdtfstate"
        CN="tfstate"
        BLOB="ismd-shared-global.tfstate"
        echo "Checking for shared-global state: $RG/$SA/$CN/$BLOB"
        # First try data-plane with login; if RBAC is missing, fall back to account key
        EXISTS=$(az storage blob exists \
          --auth-mode login \
          --account-name "$SA" \
          --container-name "$CN" \
          --name "$BLOB" \
          --query exists -o tsv 2>/dev/null || echo __ERROR__)
        if [ "$EXISTS" = "__ERROR__" ]; then
          echo "Data-plane check failed (likely missing Storage Blob Data Reader). Falling back to account key..."
          KEY=$(az storage account keys list -g "$RG" -n "$SA" --query "[0].value" -o tsv)
          EXISTS=$(az storage blob exists \
            --account-name "$SA" \
            --account-key "$KEY" \
            --container-name "$CN" \
            --name "$BLOB" \
            --query exists -o tsv 2>/dev/null || echo false)
        fi
        if [ "$EXISTS" != "true" ]; then
          echo "Shared-global state not found. Please run the 'Shared Global (App Gateway)' workflow first to provision the Application Gateway and global networking." >&2
          echo "Expected blob: https://$SA.blob.core.windows.net/$CN/$BLOB" >&2
          exit 1
        fi
    
    - name: Terraform Init
      run: terraform init
    
    - name: Terraform Format
      run: terraform fmt -recursive
      continue-on-error: true
    
    - name: Terraform Workspace
      run: terraform workspace select ${{ env.ENVIRONMENT }} || terraform workspace new ${{ env.ENVIRONMENT }}
    
    # Note: Using committed terraform.tfvars files from each environment directory.
    # Image tags are managed via lifecycle ignore_changes in Terraform.
    
    - name: Terraform Plan
      run: |
        terraform plan -out=tfplan
        
        # Display the plan for review
        echo "\n\nTerraform Plan Output:\n"
        terraform show -no-color tfplan || echo "Plan creation failed"
    
    - name: Terraform Apply
      run: |
        terraform apply -auto-approve tfplan

  shared_global_post:
    name: 'Shared-Global Post'
    uses: datagov-cz/ismd-infrastructure/.github/workflows/terraform-shared-global.yml@dev
    secrets: inherit
    needs: [terraform]
    with:
      environment: ${{ github.event.inputs.environment }}
      dev_hostname: ${{ vars.DEV_HOSTNAME }}
      test_hostname: ${{ vars.TEST_HOSTNAME }}
      prod_hostname: ${{ vars.PROD_HOSTNAME }}
      apply: true
